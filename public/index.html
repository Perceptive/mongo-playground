<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mongo Playground</title>
    <link href="https://fonts.googleapis.com/css?family=Oswald|Ubuntu+Mono" rel="stylesheet">
    <style>
      html, body {
        background: #172a3a;
        margin: 0;
        padding: 0;
        color: rgba(255, 255, 255, 0.6);
        font-family: 'Oswald', sans-serif;
      }
      main {
        width: 100%;
        height: 100%;
        position: absolute;
        display: flex;
        flex-direction: column;
      }
      h1 { text-indent: 2rem; }

      /* Disable chrome autofill input field coloring */
      input:-webkit-autofill,
      input:-webkit-autofill:hover, 
      input:-webkit-autofill:focus, 
      input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px rgb(15, 32, 45) inset !important;
        -webkit-text-fill-color: rgba(255, 255, 255, 0.6) !important;
      }

      input, select {
        color: rgba(255, 255, 255, 0.6);
        font-size: 13px;
        background: rgb(15, 32, 45);
        border-radius: 4px;
        border-width: 1px;
        border-style: solid;
        border-color: rgb(9, 20, 28);
        border-image: initial;
        padding: 6px 12px;
      }
      form {
        background: rgb(9, 20, 28);
        padding: 2rem;
        display: flex;
      }
      form > * {
        flex: 1;
        display: flex;
      }
      form input, form select {
        flex: 1;
        margin: 0 20px;
      }
      #work-area {
        display: flex;
        flex: 1;
      }
      #work-area > section {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0 1rem;
        overflow: auto;
        background: rgb(15, 32, 45);
      }
      #work-area textarea {
        height: 100%;
        padding: 1rem;
        background: rgb(23, 43, 58);
        color: rgba(255, 255, 255, 0.6);
        font-family: 'Ubuntu Mono', monospace;
        font-size: 16px;
        border: none;
      }
      #execute {
        position: absolute;
        left: 50%;
        margin-left: -36px;
        border-radius: 50px;
        height: 70px;
        width: 70px;
        margin-top: 10rem;
        background: rgb(39, 174, 96);
        border: 5px solid rgb(9, 20, 28);
        font-size: 40px;
        cursor: pointer;
      }
      #execute > .play {
        margin-left: 20px;
        position: relative;
        top: 2px;
      }
      #loader {
        display: inline-block;
        width: 45px;
        height: 45px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
        position: absolute;
        left: 10px;
        top: 10px;
      }

      @keyframes spin {
        to { -webkit-transform: rotate(360deg); }
      }
      @-webkit-keyframes spin {
        to { -webkit-transform: rotate(360deg); }
      }

      pre {
        padding: 1rem;
        margin: 0;
        height: 100%;
        font-family: 'Ubuntu Mono', monospace;
        background: rgb(23, 43, 58);
        overflow: auto;
      }
      .string { color: rgb(41, 185, 115); }
      .number { color: rgb(51, 147, 220); }
      .boolean { color: rgb(214, 66, 146); }
      .null { color: rgb(40, 130, 249); }
      .key { color: rgb(241, 143, 1); }

      .hide { display: none !important; }

      .error-circle {
        width: 30px;
        height: 30px;
        line-height: 30px;
        background: #990000;
        border-radius: 50%;
        border: 2px solid white;
        color: white;
        font-size: 15px;
        font-family: verdana;
        text-align: center;
        display: inline-block;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Mongo Playground</h1>
      <form id="form">
        <label>URL: <input type="text" name="url" required></label>
        <label>Method:
          <select name="method" required>
            <option value="aggregate">aggregate</option>
            <option value="bulkWrite">bulkWrite</option>
            <option value="countDocuments">countDocuments</option>
            <option value="createIndex">createIndex</option>
            <option value="createIndexes">createIndexes</option>
            <option value="deleteMany">deleteMany</option>
            <option value="deleteOne">deleteOne</option>
            <option value="distinct">distinct</option>
            <option value="drop">drop</option>
            <option value="dropIndex">dropIndex</option>
            <option value="dropIndexes">dropIndexes</option>
            <option value="estimatedDocumentCount">estimatedDocumentCount</option>
            <option value="find">find</option>
            <option value="findOne">findOne</option>
            <option value="findOneAndDelete">findOneAndDelete</option>
            <option value="findOneAndReplace">findOneAndReplace</option>
            <option value="findOneAndUpdate">findOneAndUpdate</option>
            <option value="geoHaystackSearch">geoHaystackSearch</option>
            <option value="indexes">indexes</option>
            <option value="indexExists">indexExists</option>
            <option value="indexInformation">indexInformation</option>
            <option value="insertMany">insertMany</option>
            <option value="insertOne">insertOne</option>
            <option value="isCapped">isCapped</option>
            <option value="listIndexes">listIndexes</option>
            <option value="mapReduce">mapReduce</option>
            <option value="options">options</option>
            <option value="parallelCollectionScan">parallelCollectionScan</option>
            <option value="reIndex">reIndex</option>
            <option value="rename">rename</option>
            <option value="replaceOne">replaceOne</option>
            <option value="stats">stats</option>
            <option value="updateMany">updateMany</option>
            <option value="updateOne">updateOne</option>
            <option value="watch">watch</option>
          </select>
        </label>
        <label>Collection name:
          <select name="collection" required>
          </select>
        </label>
      </form>
      <section id="work-area">
        <section id="left">
          <h2>Query to execute:</h2>
          <textarea name="data" id="data" cols="30" rows="10"></textarea>
          <aside class="error"></aside>
        </section>
        <section id="right">
          <h2>Response:</h2>
          <pre id="response"></pre>
        </section>
        <div id="execute" title="Execute">
          <span class="play">&#x25B6;</span>
          <span id="loader" class="hide"></span>
        </div>
      </section>
    </main>

    <script>
      /**
       * Hold result in memory for pagination
       */
      let result;

      /**
       * Syntax highlight JSON
       * @param {object|string} json - JSON text to syntax highlight
       * @returns {string}
       */
      const syntaxHighlight = (json) => {
        if (typeof json !== 'string') {
          json = JSON.stringify(json, undefined, 2);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          var cls = 'number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) cls = 'key';
            else cls = 'string';
          } else if (/true|false/.test(match)) cls = 'boolean';
          else if (/null/.test(match)) cls = 'null';

          return '<span class="' + cls + '">' + match + '</span>';
        });
      }

      /**
       * Query list of collections to aid user when user leaves the URL field
       */
      document.querySelector('#form [name="url"]').addEventListener('blur', (event) => {
        let body = {
          url: event.target.value,
        }
        if (!body.url) return;

        body = JSON.stringify(body);

        // Send request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/get-collections', true);
        xhr.responseType = 'json';
        xhr.setRequestHeader('Content-Type', 'application/json');

        // Handle response
        xhr.addEventListener('readystatechange', function () {
          if (this.readyState === 4) {
            const select = document.querySelector('#form select[name="collection"]');

            if (!this.response || !(this.response instanceof Array)) return;

            // Sort the array by name
            this.response.sort((first, second) => {
              const a = first.name.toUpperCase();
              const b = second.name.toUpperCase();
              if (a < b) return -1;
              return 1;
            })
            
            // Then populate select field
            .forEach((col) => {
              const option = document.createElement('option');
              option.value = col.name;
              option.textContent = col.name;
              select.appendChild(option);
            });
          }
        });

        xhr.send(body);
      });

      /**
       * Handle form submission
       */
      document.querySelector('#execute').addEventListener('click', (event) => {
        event.preventDefault();

        // Show loading spinner
        document.querySelector('#execute .play').classList.add('hide');
        document.querySelector('#loader').classList.remove('hide');

        const form = document.querySelector('#form');

        // We use eval here since it's the only way to convert textarea
        // value into JavaScript given that the value may not be proper
        // JSON and formatting a JavaScript object into proper JSON is
        // a huge pain.
        const data = eval(document.querySelector('textarea').value);

        // Prepare body data
        let body = {
          url: form.url.value,
          method: form.method.value,
          collection: form.collection.value,
          data,
        };

        if (!body.url || !body.method || !body.collection) return;

        body = JSON.stringify(body);

        // Send data
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/', true);
        xhr.responseType = 'json';
        xhr.setRequestHeader('Content-Type', 'application/json');

        // Handle response
        xhr.addEventListener('readystatechange', function () {
          const response = document.querySelector('#response');

          if (this.readyState === 4) {
            // Hide loading spinner
            document.querySelector('#loader').classList.add('hide');
            document.querySelector('#execute .play').classList.remove('hide');

            result = this.response;

            if (result && result instanceof Array) {
              response.innerHTML = syntaxHighlight(result.slice(0, 10));
            } else response.innerHTML = syntaxHighlight(result);
          }
        });

        xhr.send(body);
      });
    
      /**
       * Enable tabs in textarea
       */
      document.querySelector('textarea').addEventListener('keydown', (event) => {
        const keyCode = event.keyCode || event.which;
        const textarea = event.target;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const first = textarea.value.substr(0, start);
        const last = textarea.value.substr(end);

        // Tab key
        if (keyCode === 9) {
          event.preventDefault(); // don't move away from textarea

          // Add spaces
          textarea.value = `${first}  ${last}`;

          // Place cursor after spaces
          textarea.selectionStart = start + 2;
          textarea.selectionEnd = textarea.selectionStart;
        }

        // Braces and brackets
        if (keyCode === 219) {
          event.preventDefault();

          // Curly brace
          if (event.shiftKey) {
            textarea.value = `${first}{  }${last}`;

            // Set cursor
            textarea.selectionStart = start + 2;
          // Square bracket
          } else {
            textarea.value = `${first}[]${last}`;
            textarea.selectionStart = start + 1;
          }
          textarea.selectionEnd = textarea.selectionStart;
        }

        // Quotes
        if (keyCode === 222) {
          event.preventDefault();

          if (event.shiftKey) textarea.value = `${first}""${last}`;
          else textarea.value = `${first}''${last}`;

          textarea.selectionStart = start + 1;
          textarea.selectionEnd = textarea.selectionStart;
        }

        // Enter button
        if (keyCode === 13) {
          event.preventDefault();

          // Get last character
          const char = first.trim().substr(-1);

          switch (char) {
            case '{':
            case '[':
              textarea.value = `${first.trim()}\n  \n${last.trim()}`;
              textarea.selectionStart = (start - (first.length - first.trim().length)) + 3;
              break;
            default:
              textarea.value = `${first}\n${last}`;
              textarea.selectionStart = start + 1;
          }
          textarea.selectionEnd = textarea.selectionStart;
        }
      });

      /**
       * Let user know if textarea code is malformed
       */
      document.querySelector('textarea').addEventListener('keyup', (event) => {
        const error = document.querySelector('#left .error');

        try {
          eval(event.target.value);
        } catch (e) {
          return error.innerHTML = `<span class="error-circle">X</span>${e.message}`;
        }

        // Reset error message
        error.innerHTML = '';
      });
    </script>
  </body>
</html>
